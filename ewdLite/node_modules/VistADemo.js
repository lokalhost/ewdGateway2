var nodeVista = require('nodeVista');

module.exports = {

  onMessage: {

    'EWD.form.login': function(params, ewd) {
      if (params.username === '') return 'You must enter an Access Code';
      if (params.password === '') return 'You must enter a Verify Code';
      var error = nodeVista.userLogin(params, ewd);    // ***** Invoke back-end VistA logic 
      // fakedoc1/1Doc!@#$
      if (error !== '') return error;

      ewd.session.setAuthenticated();

      ewd.sendWebSocketMsg({
        type: 'loggedIn',
        message: {
          ok: true,
          name: ewd.session.$('displayName')._value
        }
      });
      return ''; 
    },

    patientQuery: function(params, ewd) {
      if (ewd.session.isAuthenticated) {  
        return nodeVista.simplePatientLookup(params,ewd);    // ***** Invoke back-end VistA logic 
      }
    },

    patientSelected: function(params, ewd) {
      if (ewd.session.isAuthenticated) {
        // record at back end for future validation of actions
        ewd.session.$('patientIdSelected')._value = params.patientId;
        return {
          patientId: params.patientId,
          patientName: ewd.session.$('names').$(params.patientId)._value
        };
      }
    }

  }
};